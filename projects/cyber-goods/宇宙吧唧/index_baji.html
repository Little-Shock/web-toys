<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‡å®™å§å”§ (Cosmic Baji)</title>
    <style>
        :root {
            --gravity-x: 0;
            --gravity-y: 0;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000000;
            margin: 0;
            perspective: 1000px;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
        }

        /* è¿”å›æŒ‰é’®æ ·å¼ */
        .back-link {
            position: fixed;
            top: 15px;
            left: 15px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 14px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .back-link:hover {
            color: white;
            background: rgba(0, 0, 0, 0.5);
        }

        /* æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .upload-container {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .upload-button {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin-bottom: 8px;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .upload-button:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .upload-icon {
            margin-right: 6px;
            font-size: 14px;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .upload-button {
                padding: 6px 12px;
                font-size: 11px;
                max-width: 130px;
            }

            .upload-icon {
                font-size: 12px;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        /* è°ƒè¯•é¢æ¿æ ·å¼ */
        .debug-panel {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 1000;
            display: none;
            max-width: 200px;
        }

        .debug-panel.active {
            display: block;
        }

        .debug-panel input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .debug-panel button {
            background: rgba(98, 0, 234, 0.4);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            margin-top: 5px;
            cursor: pointer;
        }

        .debug-panel button:hover {
            background: rgba(98, 0, 234, 0.6);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ç²’å­èƒŒæ™¯æ•ˆæœ */
        .particle-container {
            position: absolute;
            width: 375px;
            height: 375px;
            transform-style: preserve-3d;
            perspective: 1000px;
            animation: rotate 20s infinite linear;
            z-index: 0;
        }

        @keyframes rotate {
            100% {
                transform: rotateY(360deg) rotateX(360deg);
            }
        }

        .particle {
            position: absolute;
            width: 2.5px;  /* é»˜è®¤ç²’å­å¤§å°å‡å° */
            height: 2.5px;
            border-radius: 50%;
            opacity: 0;
            transform-origin: center center;
        }

        /* ç²’å­çˆ†ç‚¸åŠ¨ç”» */
        @keyframes particleExplosion {
            0% {
                transform: translate3d(0, 0, 0);
                opacity: 0.8;
            }
            100% {
                transform: translate3d(
                    calc(var(--expX) * 500px),
                    calc(var(--expY) * 500px),
                    calc(var(--expZ) * 500px)
                );
                opacity: 0;
            }
        }

        .particle.exploding {
            animation: particleExplosion 1.5s ease-out forwards !important;
        }

        .baji-container {
            width: 375px;
            height: 375px;
            perspective: 1000px; /* ç¡®ä¿æœ‰é€è§†æ•ˆæœ */
            background-color: transparent; /* ä½¿èƒŒæ™¯é€æ˜ï¼Œæ˜¾ç¤ºç²’å­ */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .baji {
            width: 250px;
            height: 250px;
            position: relative;
            cursor: pointer;
            border-radius: 50%;
            transform-style: preserve-3d;
            box-shadow: 0 0 20px rgba(255,255,255,0.35), 2px 5px 18px rgba(255,255,255,0.3);
        }

        .baji-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden; /* ç¡®ä¿åœ¨Safariä¸­ä¹Ÿç”Ÿæ•ˆ */
            display: flex;
            justify-content: center;
            align-items: center;
            transform-style: preserve-3d; /* ç¡®ä¿3Dæ•ˆæœä¿æŒ */
        }

        .baji-face img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            border-radius: 50%;
            user-select: none;  /* é˜²æ­¢å†…å®¹è¢«é€‰ä¸­ */
        }

        .baji-front {
            /* æ­£é¢ä¸éœ€è¦ç‰¹æ®Šå˜æ¢ */
            z-index: 2; /* ç¡®ä¿æ­£é¢åœ¨ä¸Šå±‚ */
            transform: translateZ(0.1px); /* å¾®å°çš„Zè½´åç§»ï¼Œç¡®ä¿åœ¨3Dç©ºé—´ä¸­æ­£ç¡®æ¸²æŸ“ */
            position: relative; /* ä¸ºç¢ç‰‡å®¹å™¨å®šä½ */
        }

        .baji-back {
            transform: rotateY(180deg);
            z-index: 1;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 50%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }

        /* ä¿®å¤èƒŒé¢å›¾ç‰‡å®šä½ */
        .baji-back img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            position: absolute;
            top: 0;
            left: 0;
            transform: none !important;
            backface-visibility: visible;
        }

        /* ç¡®ä¿èƒŒé¢å…ƒç´ çš„æ•ˆæœåœ¨å›¾ç‰‡ä¸Šæ–¹ */
        .baji-back .emboss-overlay,
        .baji-back .edge-light {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            z-index: 2; /* ç¡®ä¿åœ¨å›¾ç‰‡ä¸Šæ–¹ */
            pointer-events: none; /* ä¸å¹²æ‰°é¼ æ ‡äº‹ä»¶ */
        }

        /* --- Effects CSS --- */
        .emboss-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            box-shadow: inset 0 6px 12px rgba(255,255,255,0.8), inset 0 -6px 12px rgba(0,0,0,0.4), inset 6px 0 12px rgba(255,255,255,0.4), inset -6px 0 12px rgba(0,0,0,0.4);
            pointer-events: none; z-index: 2;
        }
        .highlight-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle at 25% 25%, rgba(255,255,255,0.85) 0%, rgba(255,255,255,0.5) 15%, rgba(255,255,255,0.2) 30%, rgba(255,255,255,0) 50%);
            pointer-events: none; z-index: 1;
        }
        .top-light {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            background: linear-gradient(120deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.4) 15%, transparent 35%);
            pointer-events: none; z-index: 3;
            opacity: 0.6;
        }
        .edge-light {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.15), inset 10px 10px 20px rgba(255,255,255,0.3);
            pointer-events: none; z-index: 1;
        }
        /* --- End of effects CSS --- */

        /* --- ç¢ç‰‡æ•ˆæœ CSS --- */
        .shards-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            pointer-events: none;
            z-index: 2;
            mix-blend-mode: screen;
        }

        .shard {
            position: absolute;
            pointer-events: none;
            transform-origin: center center;
        }

        .shard-enhanced {
            position: absolute;
            pointer-events: none;
            transform-origin: center center;
            box-shadow: 0 0 4px 2px rgba(255, 255, 255, 0.7);
        }
        /* --- End of ç¢ç‰‡æ•ˆæœ CSS --- */

        /* --- Micro-motion (Sway) Animation --- */
        @keyframes sway-animation {
            0% { transform: rotateY(-12deg) rotateX(4deg); }
            50% { transform: rotateY(12deg) rotateX(-4deg); }
            100% { transform: rotateY(-12deg) rotateX(4deg); }
        }

        .baji.default-sway {
            animation: sway-animation 4s ease-in-out infinite;
        }

        /* å½“ä½¿ç”¨é‡åŠ›æ„Ÿåº”æ—¶ï¼Œåœæ­¢é»˜è®¤åŠ¨ç”» */
        .baji.gyro-active {
            animation: none;
        }
        /* --- End of Sway Animation --- */

        /* --- å…‰çº¿å˜å¹»æ•ˆæœ --- */
        .dynamic-light {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            opacity: 0.5;
            pointer-events: none;
            z-index: 4;
            mix-blend-mode: overlay;
            transition: all 0.1s ease-out;
        }
        /* --- End of å…‰çº¿å˜å¹»æ•ˆæœ --- */

        /* --- Single Click 360 Spin Animation --- */
        @keyframes spin-360 {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        .baji.perform-spin {
            animation: spin-360 1s ease-in-out;
        }
        /* --- End of Single Click Spin Animation --- */

    </style>
</head>
<body>
    <!-- è¿”å›ä¸»èœå•é“¾æ¥ -->
    <a href="../../../index.html" class="back-link">è¿”å›ä¸»èœå•</a>

    <!-- ç²’å­ç‰¹æ•ˆå®¹å™¨ -->
    <div class="particle-container" id="particleContainer"></div>

    <div class="baji-container">
        <div class="baji default-sway" id="baji">
            <div class="baji-face baji-front">
                <img src="https://oss.talesofai.cn/fe_assets/mng/17/f29f43ac4481bb4de8278ad6a73c04d3.jpg" alt="å§å”§æ­£é¢" id="frontImage">
                <div class="shards-container" id="shardsContainer"></div>
                <div class="emboss-overlay" id="embossOverlayFront"></div>
                <div class="highlight-overlay" id="highlightOverlayFront"></div>
                <div class="top-light" id="topLightFront"></div>
                <div class="edge-light" id="edgeLightFront"></div>
                <div class="dynamic-light" id="dynamicLightFront"></div>
            </div>
            <div class="baji-face baji-back">
                <img src="https://oss.talesofai.cn/fe_assets/mng/17/1c0b32094074e69513e3fa897d8325ed.jpg" alt="å§å”§èƒŒé¢" id="backImage">
                <div class="emboss-overlay"></div>
                <div class="edge-light"></div>
            </div>
        </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’®å®¹å™¨ -->
    <div class="upload-container">
        <button class="upload-button" id="uploadButton" style="margin-bottom: 10px;">
            <span class="upload-icon">ğŸ“·</span>
            <span>ä¸Šä¼ è‡ªå®šä¹‰å›¾ç‰‡</span>
        </button>
        <button class="upload-button" id="gyroButton" style="background: rgba(98, 0, 234, 0.2); margin-bottom: 10px;">
            <span class="upload-icon">ğŸ“±</span>
            <span id="gyroButtonText">å¼€å¯é‡åŠ›æ„Ÿåº”</span>
        </button>
        <button class="upload-button" id="debugButton" style="background: rgba(0, 0, 0, 0.2);">
            <span class="upload-icon">âš™ï¸</span>
            <span>è°ƒè¯•è®¾ç½®</span>
        </button>
        <input type="file" id="imageUpload" accept="image/*" style="display: none;">
    </div>

    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- è°ƒè¯•é¢æ¿ -->
    <div class="debug-panel" id="debugPanel">
        <div>æŒæ¡è§’åº¦è°ƒæ•´: <span id="betaAngleValue">50</span>Â°</div>
        <input type="range" id="betaAngleSlider" min="30" max="70" value="50" step="1">
        <div id="deviceInfo"></div>
        <button id="toggleDebugBtn">å…³é—­è°ƒè¯•</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const bajiElement = document.getElementById('baji');
            const shardsContainer = document.getElementById('shardsContainer');
            const particleContainer = document.getElementById('particleContainer');
            const uploadButton = document.getElementById('uploadButton');
            const gyroButton = document.getElementById('gyroButton');
            const gyroButtonText = document.getElementById('gyroButtonText');
            const imageUpload = document.getElementById('imageUpload');
            const frontImage = document.getElementById('frontImage');
            const backImage = document.getElementById('backImage');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const dynamicLightFront = document.getElementById('dynamicLightFront');

            // è°ƒè¯•ç›¸å…³å…ƒç´ 
            const debugButton = document.getElementById('debugButton');
            const debugPanel = document.getElementById('debugPanel');
            const betaAngleSlider = document.getElementById('betaAngleSlider');
            const betaAngleValue = document.getElementById('betaAngleValue');
            const deviceInfo = document.getElementById('deviceInfo');
            const toggleDebugBtn = document.getElementById('toggleDebugBtn');

            // é‡åŠ›æ„Ÿåº”çŠ¶æ€
            let gyroActive = false;
            let gyroPermissionGranted = false;

            // ç”¨æˆ·æŒæ¡è§’åº¦åå¥½ (é»˜è®¤ä¸º50åº¦)
            let preferredBetaAngle = 50;

            // ä¿å­˜ä¸Šä¼ çš„å›¾ç‰‡URL
            let customImageUrl = null;

            // æ˜¯å¦æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
            let showDebugInfo = false;

            // è¿”å›æŒ‰é’®é“¾æ¥ç”±back-link-fix-new.jså¤„ç†
            // ä¸å†éœ€è¦è¿™é‡Œçš„ä»£ç 

            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            function isMobileDevice() {
                return (window.innerWidth <= 768) ||
                       /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯iOSè®¾å¤‡
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

            // æ›´æ–°iOSè®¾å¤‡ä¸Šçš„æŒ‰é’®æ–‡æœ¬
            if (isIOS && window.DeviceOrientationEvent &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                gyroButtonText.textContent = 'ç‚¹å‡»å¯ç”¨é‡åŠ›æ„Ÿåº”';
            }

            // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šè‡ªåŠ¨å¯ç”¨é‡åŠ›æ„Ÿåº”ï¼ˆä»…Androidè®¾å¤‡ï¼‰
            if (isMobileDevice()) {
                // å»¶è¿Ÿä¸€ç‚¹å¯åŠ¨é‡åŠ›æ„Ÿåº”ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
                setTimeout(() => {
                    // å¦‚æœä¸æ˜¯iOSè®¾å¤‡ï¼Œè‡ªåŠ¨å¯ç”¨é‡åŠ›æ„Ÿåº”
                    // iOSè®¾å¤‡éœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®å¯ç”¨ï¼Œé¿å…æƒé™å¼¹çª—å¯¼è‡´é—®é¢˜
                    if (!isIOS && window.DeviceOrientationEvent &&
                        typeof DeviceOrientationEvent.requestPermission !== 'function') {
                        activateGyroscope();
                    }
                }, 1000);
            }

            // å¤„ç†ä¸Šä¼ æŒ‰é’®ç‚¹å‡»
            uploadButton.addEventListener('click', function() {
                imageUpload.click();
            });

            // å¤„ç†é‡åŠ›æ„Ÿåº”æŒ‰é’®ç‚¹å‡»
            gyroButton.addEventListener('click', function() {
                if (!gyroActive) {
                    // å°è¯•å¯ç”¨é‡åŠ›æ„Ÿåº”
                    enableGyroscope();
                } else {
                    // ç¦ç”¨é‡åŠ›æ„Ÿåº”
                    disableGyroscope();
                }
            });

            // å¤„ç†è°ƒè¯•æŒ‰é’®ç‚¹å‡»
            debugButton.addEventListener('click', function() {
                toggleDebugPanel();
            });

            // å¤„ç†è°ƒè¯•é¢æ¿ä¸­çš„è§’åº¦æ»‘å—å˜åŒ–
            betaAngleSlider.addEventListener('input', function() {
                preferredBetaAngle = parseInt(this.value);
                betaAngleValue.textContent = preferredBetaAngle;
                // å¦‚æœé‡åŠ›æ„Ÿåº”å·²æ¿€æ´»ï¼Œç«‹å³åº”ç”¨æ–°çš„è§’åº¦è®¾ç½®
                if (gyroActive) {
                    // è§¦å‘ä¸€æ¬¡æ–¹å‘äº‹ä»¶å¤„ç†ï¼Œåº”ç”¨æ–°è®¾ç½®
                    const lastOrientationEvent = window.lastOrientationEvent;
                    if (lastOrientationEvent) {
                        handleOrientation(lastOrientationEvent);
                    }
                }
            });

            // å¤„ç†è°ƒè¯•é¢æ¿ä¸­çš„åˆ‡æ¢æŒ‰é’®
            toggleDebugBtn.addEventListener('click', function() {
                toggleDebugPanel();
            });

            // åˆ‡æ¢è°ƒè¯•é¢æ¿æ˜¾ç¤º/éšè—
            function toggleDebugPanel() {
                showDebugInfo = !showDebugInfo;
                debugPanel.classList.toggle('active', showDebugInfo);
                debugButton.style.background = showDebugInfo ?
                    'rgba(0, 0, 0, 0.6)' : 'rgba(0, 0, 0, 0.2)';

                // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                toggleDebugBtn.textContent = showDebugInfo ? 'å…³é—­è°ƒè¯•' : 'å¼€å¯è°ƒè¯•';
            }

            // å¯ç”¨é‡åŠ›æ„Ÿåº”
            function enableGyroscope() {
                // æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ”¯æŒDeviceOrientationäº‹ä»¶
                if (window.DeviceOrientationEvent) {
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦è¯·æ±‚æƒé™ï¼ˆiOS 13+ï¼‰
                    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                        DeviceOrientationEvent.requestPermission()
                            .then(permissionState => {
                                if (permissionState === 'granted') {
                                    // æƒé™å·²æˆäºˆï¼Œå¯ç”¨é‡åŠ›æ„Ÿåº”
                                    activateGyroscope();
                                } else {
                                    alert('éœ€è¦é‡åŠ›æ„Ÿåº”æƒé™æ‰èƒ½å¯ç”¨æ­¤åŠŸèƒ½');
                                }
                            })
                            .catch(error => {
                                console.error('è·å–é‡åŠ›æ„Ÿåº”æƒé™å¤±è´¥:', error);
                                alert('æ— æ³•è·å–é‡åŠ›æ„Ÿåº”æƒé™');
                            });
                    } else {
                        // ä¸éœ€è¦è¯·æ±‚æƒé™çš„è®¾å¤‡ï¼ˆAndroidç­‰ï¼‰
                        activateGyroscope();
                    }
                } else {
                    alert('æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒé‡åŠ›æ„Ÿåº”åŠŸèƒ½');
                }
            }

            // æ¿€æ´»é‡åŠ›æ„Ÿåº”
            function activateGyroscope() {
                gyroActive = true;
                gyroPermissionGranted = true;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                gyroButton.style.background = 'rgba(98, 0, 234, 0.6)';
                gyroButton.querySelector('span:last-child').textContent = 'å…³é—­é‡åŠ›æ„Ÿåº”';

                // æ·»åŠ gyro-activeç±»ï¼Œåœæ­¢é»˜è®¤åŠ¨ç”»
                bajiElement.classList.remove('default-sway');
                bajiElement.classList.add('gyro-active');

                // æ·»åŠ è®¾å¤‡æ–¹å‘äº‹ä»¶ç›‘å¬å™¨
                window.addEventListener('deviceorientation', handleOrientation);

                // æ·»åŠ å±å¹•æ–¹å‘å˜åŒ–ç›‘å¬å™¨ï¼Œä»¥ä¾¿åœ¨è®¾å¤‡æ—‹è½¬æ—¶è°ƒæ•´æ˜¾ç¤º
                window.addEventListener('resize', handleScreenOrientationChange);

                // å¦‚æœæµè§ˆå™¨æ”¯æŒå±å¹•æ–¹å‘å˜åŒ–äº‹ä»¶ï¼Œä¹Ÿæ·»åŠ è¿™ä¸ªç›‘å¬å™¨
                if (window.screen && window.screen.orientation) {
                    window.screen.orientation.addEventListener('change', handleScreenOrientationChange);
                } else if (window.orientation !== undefined) {
                    // æ—§ç‰ˆAPIæ”¯æŒ
                    window.addEventListener('orientationchange', handleScreenOrientationChange);
                }
            }

            // ç¦ç”¨é‡åŠ›æ„Ÿåº”
            function disableGyroscope() {
                gyroActive = false;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                gyroButton.style.background = 'rgba(98, 0, 234, 0.2)';
                gyroButton.querySelector('span:last-child').textContent = 'å¼€å¯é‡åŠ›æ„Ÿåº”';

                // ç§»é™¤gyro-activeç±»ï¼Œæ¢å¤é»˜è®¤åŠ¨ç”»
                bajiElement.classList.remove('gyro-active');
                bajiElement.classList.add('default-sway');

                // é‡ç½®å§å”§å’Œå…‰çº¿æ•ˆæœçš„ä½ç½®
                bajiElement.style.transform = '';
                dynamicLightFront.style.background = 'radial-gradient(circle at 50% 50%, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%)';

                // ç§»é™¤è®¾å¤‡æ–¹å‘äº‹ä»¶ç›‘å¬å™¨
                window.removeEventListener('deviceorientation', handleOrientation);

                // ç§»é™¤å±å¹•æ–¹å‘å˜åŒ–ç›‘å¬å™¨
                window.removeEventListener('resize', handleScreenOrientationChange);

                // ç§»é™¤å±å¹•æ–¹å‘å˜åŒ–çš„ä¸“ç”¨äº‹ä»¶ç›‘å¬å™¨
                if (window.screen && window.screen.orientation) {
                    window.screen.orientation.removeEventListener('change', handleScreenOrientationChange);
                } else if (window.orientation !== undefined) {
                    window.removeEventListener('orientationchange', handleScreenOrientationChange);
                }
            }

            // å¤„ç†å±å¹•æ–¹å‘å˜åŒ–
            function handleScreenOrientationChange() {
                // å½“å±å¹•å°ºå¯¸å˜åŒ–æ—¶ï¼Œå¯èƒ½æ˜¯è®¾å¤‡æ—‹è½¬ï¼Œé‡æ–°åº”ç”¨å½“å‰çš„æ–¹å‘æ•°æ®
                if (gyroActive) {
                    // é‡ç½®å§å”§ä½ç½®ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡è®¾å¤‡æ–¹å‘äº‹ä»¶æ›´æ–°
                    bajiElement.style.transform = '';
                    dynamicLightFront.style.background = 'radial-gradient(circle at 50% 50%, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%)';
                }
            }

            // æ£€æµ‹å±å¹•æ–¹å‘ï¼ˆç«–å±/æ¨ªå±ï¼‰
            function isPortraitMode() {
                return window.innerHeight > window.innerWidth;
            }

            // å¤„ç†è®¾å¤‡æ–¹å‘å˜åŒ–
            function handleOrientation(event) {
                if (!gyroActive) return;

                // ä¿å­˜æœ€åä¸€æ¬¡æ–¹å‘äº‹ä»¶ï¼Œç”¨äºè°ƒè¯•é¢æ¿è°ƒæ•´æ—¶é‡æ–°åº”ç”¨
                window.lastOrientationEvent = event;

                // è·å–è®¾å¤‡æ–¹å‘æ•°æ®
                const beta = event.beta;  // Xè½´æ—‹è½¬ (-180 åˆ° 180)
                const gamma = event.gamma; // Yè½´æ—‹è½¬ (-90 åˆ° 90)
                const alpha = event.alpha; // Zè½´æ—‹è½¬ (0 åˆ° 360)

                // æ£€æŸ¥æ˜¯å¦ä¸ºç«–å±æ¨¡å¼
                const isPortrait = isPortraitMode();

                // é™åˆ¶å€¾æ–œè§’åº¦èŒƒå›´
                const maxTilt = 15;

                let tiltX, tiltY;

                if (isPortrait) {
                    // ç«–å±æ¨¡å¼ä¸‹çš„åæ ‡æ˜ å°„è°ƒæ•´
                    // åœ¨ç«–å±æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›è®¾å¤‡æ­£é¢æœå‘ç”¨æˆ·æ—¶æ˜¾ç¤ºå§å”§çš„æ­£é¢

                    // gammaå¯¹åº”å·¦å³å€¾æ–œ (-90 åˆ° 90)
                    // ä¿æŒå·¦å³å€¾æ–œçš„æ˜ å°„ä¸å˜
                    tiltX = Math.max(-maxTilt, Math.min(maxTilt, gamma));

                    // betaå¯¹åº”å‰åå€¾æ–œ (-180 åˆ° 180)
                    // ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„æŒæ¡è§’åº¦ä½œä¸ºåŸºå‡†ç‚¹
                    const betaOffset = preferredBetaAngle; // ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„è§’åº¦
                    const adjustedBeta = beta - betaOffset;

                    // é™åˆ¶è°ƒæ•´åçš„betaå€¼èŒƒå›´ï¼Œå¹¶åè½¬æ–¹å‘ä½¿å…¶æ›´ç›´è§‚
                    // å½“è®¾å¤‡å‘å‰å€¾æ–œæ—¶ï¼Œå§å”§å‘ä¸Šå€¾æ–œï¼›å‘åå€¾æ–œæ—¶ï¼Œå§å”§å‘ä¸‹å€¾æ–œ
                    tiltY = Math.max(-maxTilt, Math.min(maxTilt, -adjustedBeta));
                } else {
                    // æ¨ªå±æ¨¡å¼ä¸‹çš„å¤„ç†æ–¹å¼
                    // åœ¨æ¨ªå±æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ä¸åŒçš„æ˜ å°„
                    tiltX = Math.max(-maxTilt, Math.min(maxTilt, gamma));

                    // åœ¨æ¨ªå±æ¨¡å¼ä¸‹ï¼Œbeta=0æ—¶è®¾å¤‡å¹³æ”¾ï¼Œæˆ‘ä»¬å¸Œæœ›æ˜¾ç¤ºå§å”§æ­£é¢
                    tiltY = Math.max(-maxTilt, Math.min(maxTilt, beta));
                }

                // åº”ç”¨å€¾æ–œæ•ˆæœåˆ°å§å”§
                bajiElement.style.transform = `rotateY(${tiltX}deg) rotateX(${-tiltY}deg)`;

                // è®¡ç®—å…‰çº¿ä½ç½®ï¼ˆæ ¹æ®å€¾æ–œè§’åº¦ç§»åŠ¨å…‰æºï¼‰
                const lightPosX = 50 + (tiltX / maxTilt) * 30; // 30%çš„ç§»åŠ¨èŒƒå›´
                const lightPosY = 50 + (tiltY / maxTilt) * 30;

                // æ›´æ–°åŠ¨æ€å…‰çº¿æ•ˆæœ
                dynamicLightFront.style.background = `radial-gradient(circle at ${lightPosX}% ${lightPosY}%, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%)`;

                // æ ¹æ®å€¾æ–œè§’åº¦è°ƒæ•´ç²’å­è¡Œä¸ºï¼ˆè½»å¾®å½±å“ï¼‰
                updateParticlesWithTilt(tiltX, tiltY);

                // å¦‚æœè°ƒè¯•é¢æ¿æ‰“å¼€ï¼Œæ›´æ–°è®¾å¤‡ä¿¡æ¯
                if (showDebugInfo && deviceInfo) {
                    deviceInfo.innerHTML = `
                        <div style="margin-top: 8px;">è®¾å¤‡æ–¹å‘æ•°æ®:</div>
                        <div>Beta: ${beta.toFixed(1)}Â°</div>
                        <div>Gamma: ${gamma.toFixed(1)}Â°</div>
                        <div>è°ƒæ•´åBeta: ${(beta - preferredBetaAngle).toFixed(1)}Â°</div>
                        <div>å±å¹•æ¨¡å¼: ${isPortrait ? 'ç«–å±' : 'æ¨ªå±'}</div>
                    `;
                }
            }

            // æ ¹æ®å€¾æ–œè§’åº¦æ›´æ–°ç²’å­è¡Œä¸º
            function updateParticlesWithTilt(tiltX, tiltY) {
                // è®¡ç®—å€¾æ–œæ–¹å‘çš„é‡åŠ›å½±å“
                const gravityX = tiltX / 15; // å½’ä¸€åŒ–åˆ° -1 åˆ° 1 çš„èŒƒå›´
                const gravityY = tiltY / 15;

                // æ›´æ–°ç²’å­å®¹å™¨çš„å˜æ¢ï¼Œåˆ›é€ å¾®å¦™çš„æ•´ä½“ç§»åŠ¨æ•ˆæœ
                particleContainer.style.transform = `translate(${gravityX * 5}px, ${gravityY * 5}px)`;

                // ä¸ºç²’å­æ·»åŠ ä¸€ä¸ªå¾®å¦™çš„CSSå˜é‡ï¼Œå¯ä»¥åœ¨åŠ¨ç”»ä¸­ä½¿ç”¨
                document.documentElement.style.setProperty('--gravity-x', gravityX);
                document.documentElement.style.setProperty('--gravity-y', gravityY);

                // å…‰çº¿å¼ºåº¦éšå€¾æ–œè§’åº¦å˜åŒ–
                const tiltMagnitude = Math.sqrt(tiltX * tiltX + tiltY * tiltY) / 15; // 0-1èŒƒå›´
                const lightIntensity = 0.5 + tiltMagnitude * 0.3; // 0.5-0.8èŒƒå›´

                // æ›´æ–°åŠ¨æ€å…‰çº¿çš„å¼ºåº¦
                dynamicLightFront.style.opacity = lightIntensity;
            }

            // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
            imageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                loadingOverlay.classList.add('active');

                // åˆ›å»ºå›¾ç‰‡URL
                const url = URL.createObjectURL(file);

                // ä¿å­˜ä¸Šä¼ çš„å›¾ç‰‡URL
                customImageUrl = url;

                // åˆ›å»ºæ–°å›¾åƒå¯¹è±¡ç”¨äºé¢„åŠ è½½
                const img = new Image();
                img.onload = function() {
                    // åªæ›´æ–°æ­£é¢å›¾ç‰‡ï¼Œä¿ç•™åŸå§‹çš„èƒŒé¢å›¾ç‰‡ï¼ˆå¸¦åˆ«é’ˆçš„æ•ˆæœï¼‰
                    frontImage.src = customImageUrl;

                    // ç¡®ä¿èƒŒé¢å›¾ç‰‡æ ·å¼æ­£ç¡®åº”ç”¨
                    backImage.style.position = 'absolute';
                    backImage.style.top = '0';
                    backImage.style.left = '0';
                    backImage.style.width = '100%';
                    backImage.style.height = '100%';
                    backImage.style.objectFit = 'cover';
                    backImage.style.borderRadius = '50%';
                    backImage.style.transform = 'none';
                    backImage.style.backfaceVisibility = 'visible';

                    // éšè—åŠ è½½åŠ¨ç”»
                    setTimeout(() => {
                        loadingOverlay.classList.remove('active');
                    }, 500);
                };

                img.onerror = function() {
                    alert('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•å…¶ä»–å›¾ç‰‡');
                    loadingOverlay.classList.remove('active');
                };

                img.src = url;
            });

            // è·å–è§†çª—å¤§å°
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;

            // åˆ›å»ºèƒŒæ™¯ç²’å­æ•ˆæœ
            const totalParticles = 350; // ç²’å­æ€»æ•°
            const canvasSize = 375; // ç”»å¸ƒå°ºå¯¸
            const bajiSize = 250; // å§å”§å°ºå¯¸
            const minOrbitSize = 140; // æœ€å°è½¨é“å°ºå¯¸ï¼Œç¨å¤§äºå§å”§åŠå¾„
            const maxOrbitSize = 180; // æœ€å¤§è½¨é“å°ºå¯¸ï¼Œå°äºç”»å¸ƒåŠå¾„

            // åˆå§‹å±å¹•å°ºå¯¸
            const screenSize = Math.max(windowWidth, windowHeight) * 0.7; // ä½¿ç”¨å±å¹•è¾ƒå¤§å°ºå¯¸çš„70%

            // å¢å¼ºçš„ç²’å­é¢œè‰²æ•°ç»„ï¼Œæ·»åŠ æ›´å¤šå˜åŒ–å’Œä¸€äº›äº®è‰²
            const particleColors = [
                // åŸå§‹é“¶è‰²å’Œé“¶è“è‰²ç³»
                '#A0A0A0', // æš—é“¶è‰²
                '#B3B3B3', // æš—æ·¡ç°è‰²
                '#C6C8DA', // æš—é“¶è“è‰²
                '#90A4BE', // æš—é’¢è“
                '#ACACDF', // æš—è–°è¡£è‰è“
                '#C6C6DA', // æš—è–°è¡£è‰æ·¡ç´«
                '#D0D8DF', // æš—çˆ±ä¸½ä¸è“
                '#959595', // æ·±æš—é“¶è‰²
                '#898989', // æš—ç°è‰²é“¶
                '#BCBCBC', // æš—äº®ç°è‰²

                // æ·»åŠ ä¸€äº›äº®è‰²å’Œæ˜Ÿå…‰è‰²å½©ï¼ˆä½é¢‘ç‡å‡ºç°ï¼‰
                '#E0E8FF', // äº®è“ç™½
                '#D8F0FF', // æ·¡å¤©è“
                '#E6E6FA', // è–°è¡£è‰è‰²
                '#B0C4DE', // äº®é’¢è“
                '#ADD8E6', // äº®è“è‰²
                '#87CEEB', // å¤©è“è‰²
                '#B0E0E6', // ç²‰è“è‰²
                '#F0FFFF', // å¤©è“ç™½
                '#E6E6FF', // æ·¡ç´«è“
                '#F5F5FF'  // å¹½çµç™½
            ];

            // è¾…åŠ©å‡½æ•°: å¹³å‡åˆ†å¸ƒç²’å­
            function getFibonacciSpherePoint(i, n, randomize = true) {
                const offset = 2.0 / n;
                const phi = Math.acos(1 - (i + 0.5) * offset);
                const theta = Math.PI * (1 + 5**0.5) * (i + (randomize ? Math.random() * 0.2 - 0.1 : 0));

                const x = Math.cos(theta) * Math.sin(phi);
                const y = Math.sin(theta) * Math.sin(phi);
                const z = Math.cos(phi);

                return { x, y, z };
            }

            // ç¡®ä¿æ ·å¼è¡¨å¯è®¿é—®
            const styleSheet = document.styleSheets[0];
            const definedKeyframes = new Set();

            // è¾…åŠ©å‡½æ•°: ç¡®ä¿å…³é”®å¸§åªå®šä¹‰ä¸€æ¬¡
            function ensureKeyframe(name, rule) {
                if (!definedKeyframes.has(name)) {
                    try {
                        styleSheet.insertRule(`@keyframes ${name} { ${rule} }`, styleSheet.cssRules.length);
                        definedKeyframes.add(name);
                    } catch (e) {
                        console.warn("Could not insert keyframe (might already exist or be invalid):", name, e);
                    }
                }
            }

            // ç²’å­å¼•ç”¨æ•°ç»„ï¼Œç”¨äºçˆ†ç‚¸æ•ˆæœ
            const particles = [];

            // ç”Ÿæˆç²’å­
            for (let i = 0; i < totalParticles; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';

                // ä½¿ç”¨æ–æ³¢é‚£å¥‘çƒé¢åˆ†å¸ƒç®—æ³•è·å–å‡åŒ€åˆ†å¸ƒçš„ç‚¹
                const point = getFibonacciSpherePoint(i, totalParticles);

                // éšæœºé€‰æ‹©é¢œè‰²
                const randomColor = particleColors[Math.floor(Math.random() * particleColors.length)];
                particle.style.backgroundColor = randomColor;

                // éšæœºè½¨é“å¤§å°
                const orbitScale = minOrbitSize + Math.random() * (maxOrbitSize - minOrbitSize);

                // éšæœºç²’å­å¤§å° (1.5px - 4.5px) - å¢åŠ ä¸€äº›å˜åŒ–
                const particleSize = 1.5 + Math.random() * 3.0;
                particle.style.width = `${particleSize}px`;
                particle.style.height = `${particleSize}px`;

                // å¢å¼ºçš„å…‰æ™•æ•ˆæœ - æ·»åŠ ä¸€äº›æ›´äº®çš„ç²’å­
                let glowIntensity;

                // 10%çš„ç²’å­æœ‰æ›´å¼ºçš„å…‰æ™•æ•ˆæœ
                if (Math.random() < 0.1) {
                    glowIntensity = Math.random() * 5 + 3; // 3-8px å¼ºå…‰æ™•
                    // å¯¹äºäº®ç²’å­ï¼Œå¢åŠ ä¸€ç‚¹é€æ˜åº¦å˜åŒ–
                    particle.style.opacity = 0.7 + Math.random() * 0.3;
                } else {
                    glowIntensity = Math.random() * 3 + 1; // 1-4px æ™®é€šå…‰æ™•
                }

                particle.style.boxShadow = `0 0 ${glowIntensity}px ${randomColor}`;

                // è®¾ç½®åˆå§‹ä½ç½®ä¸ºç”»å¸ƒä¸­å¿ƒ
                particle.style.left = `${canvasSize / 2}px`;
                particle.style.top = `${canvasSize / 2}px`;

                // ä¸ºçˆ†ç‚¸æ•ˆæœå‡†å¤‡æ–¹å‘å˜é‡
                const expX = point.x;
                const expY = point.y;
                const expZ = point.z;
                particle.style.setProperty('--expX', expX);
                particle.style.setProperty('--expY', expY);
                particle.style.setProperty('--expZ', expZ);

                // åˆ›å»ºå”¯ä¸€çš„åŠ¨ç”»å
                const animName = `particleOrbit${i}`;

                // è®¾ç½®éšæœºåŠ¨ç”»æ—¶é•¿ (10-20ç§’)
                const duration = 10 + Math.random() * 10;

                // è®¾ç½®éšæœºå»¶è¿Ÿ (0-5ç§’)
                const delay = Math.random() * 5;

                // åˆ›å»ºåŠ¨ç”» - ä»å±å¹•å¤§å°å¼€å§‹ï¼Œç„¶åæ”¶ç¼©åˆ°è½¨é“å¤§å°
                const keyframes = `
                    @keyframes ${animName} {
                        0%, 100% {
                            opacity: 0;
                            transform: translate3d(0, 0, 0) scale(0.3);
                        }
                        15% {
                            opacity: 0.8;
                            transform: translate3d(
                                calc(${point.x * screenSize}px + var(--gravity-x) * 10px),
                                calc(${point.y * screenSize}px + var(--gravity-y) * 10px),
                                ${point.z * screenSize}px
                            ) scale(1);
                        }
                        30% {
                            transform: translate3d(
                                calc(${point.x * orbitScale}px + var(--gravity-x) * 5px),
                                calc(${point.y * orbitScale}px + var(--gravity-y) * 5px),
                                ${point.z * orbitScale}px
                            ) scale(1);
                        }
                        70% {
                            opacity: 0.6;
                            transform: translate3d(
                                calc(${point.x * orbitScale}px + var(--gravity-x) * 5px),
                                calc(${point.y * orbitScale}px + var(--gravity-y) * 5px),
                                ${point.z * orbitScale}px
                            ) scale(1);
                        }
                        85% {
                            opacity: 0.8;
                            transform: translate3d(
                                calc(${point.x * screenSize * 0.5}px + var(--gravity-x) * 8px),
                                calc(${point.y * screenSize * 0.5}px + var(--gravity-y) * 8px),
                                ${point.z * screenSize * 0.5}px
                            ) scale(0.8);
                        }
                    }
                `;

                try {
                    styleSheet.insertRule(keyframes, styleSheet.cssRules.length);
                } catch(e) {
                    console.warn("æ— æ³•æ’å…¥å…³é”®å¸§è§„åˆ™:", e);
                }

                // åº”ç”¨åŠ¨ç”»
                particle.style.animation = `${animName} ${duration}s infinite ease-in-out`;
                particle.style.animationDelay = `${delay}s`;

                // æ·»åŠ åˆ°å®¹å™¨
                particleContainer.appendChild(particle);

                // å­˜å‚¨ç²’å­å¼•ç”¨
                particles.push(particle);
            }

            // è§¦å‘ç²’å­çˆ†ç‚¸æ•ˆæœ
            function explodeParticles() {
                particles.forEach(particle => {
                    // ä¿å­˜å½“å‰åŠ¨ç”»çŠ¶æ€
                    const originalAnimation = particle.style.animation;
                    const originalDelay = particle.style.animationDelay;

                    // æ·»åŠ çˆ†ç‚¸åŠ¨ç”»ç±»
                    particle.classList.add('exploding');

                    // çˆ†ç‚¸åŠ¨ç”»ç»“æŸåæ¢å¤åŸæ¥çš„åŠ¨ç”»
                    setTimeout(() => {
                        particle.classList.remove('exploding');
                        particle.style.animation = originalAnimation;
                        particle.style.animationDelay = originalDelay;
                    }, 1500); // çˆ†ç‚¸åŠ¨ç”»æ—¶é•¿
                });
            }

            // ç¡®ä¿èƒŒé¢å›¾ç‰‡æ­£ç¡®æ˜¾ç¤º
            // æ³¨æ„ï¼šbackImageå·²ç»åœ¨é¡¶éƒ¨å£°æ˜ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨
            if (backImage) {
                // å¼ºåˆ¶ç¡®ä¿èƒŒé¢å›¾ç‰‡æ ·å¼æ­£ç¡®åº”ç”¨
                backImage.style.position = 'absolute';
                backImage.style.top = '0';
                backImage.style.left = '0';
                backImage.style.width = '100%';
                backImage.style.height = '100%';
                backImage.style.objectFit = 'cover';
                backImage.style.borderRadius = '50%';
                backImage.style.transform = 'none';
                backImage.style.backfaceVisibility = 'visible';
            }

            // ç¢ç‰‡æ•ˆæœ - å‡å°‘æ•°é‡
            if (shardsContainer) {
                const circleRadius = 125; // å§å”§å®¹å™¨å®½åº¦çš„ä¸€åŠ
                const numberOfShards = 66; // å‡å°‘åˆ°70ä¸ªäº®ç‰‡

                // ç®€åŒ–é¢œè‰²åˆ†å¸ƒï¼Œä¸»è¦ä½¿ç”¨ç™½è‰²å’Œæ·¡è‰²ç³»
                const shardColors = [
                    '#ffffff', '#ffffff', '#ffffff',
                    '#f0f8ff', '#e0ffff',
                    '#ff00ff',
                    '#00ffff',
                    '#ccffcc'
                ];

                // å®šä¹‰ç¢ç‰‡çš„åŠ¨ç”»
                ensureKeyframe('shardShimmer', `
                    0%, 100% { opacity: 0.4; filter: brightness(0.7) saturate(140%); transform: scale(0.85); }
                    50% { opacity: 0.9; filter: brightness(2.5) saturate(300%); transform: scale(1.15); }
                `);

                ensureKeyframe('shardDrift', `
                    0% { transform: translate(var(--tx-start, 0px), var(--ty-start, 0px)) rotate(var(--r-start, 0deg)) scale(var(--s-drift-start, 1)); }
                    50% { transform: translate(var(--tx-mid, 0px), var(--ty-mid, 0px)) rotate(var(--r-mid, 180deg)) scale(var(--s-drift-mid, 1)); }
                    100% { transform: translate(var(--tx-end, 0px), var(--ty-end, 0px)) rotate(var(--r-end, 360deg)) scale(var(--s-drift-end, 1)); }
                `);

                // å¢å¼ºå‹äº®ç‰‡çš„é—ªçƒåŠ¨ç”»
                ensureKeyframe('enhancedShardShimmer', `
                    0%, 100% { opacity: 0.6; filter: brightness(0.9) saturate(160%); transform: scale(0.9); }
                    50% { opacity: 1.0; filter: brightness(3.0) saturate(350%); transform: scale(1.2); }
                `);

                // åˆ›å»ºè¾¹ç¼˜èšé›†ä½†æœ‰ä¸€äº›ä¸­å¿ƒåˆ†å¸ƒçš„äº®ç‰‡
                function getRandomPosition() {
                    const angle = Math.random() * 2 * Math.PI;
                    let r;
                    const rand = Math.random();

                    if (rand < 0.6) {
                        // 60%çš„äº®ç‰‡é›†ä¸­åœ¨è¾¹ç¼˜åŒºåŸŸ
                        r = (0.65 + rand * 0.3) * circleRadius;
                    } else if (rand < 0.9) {
                        // 30%çš„äº®ç‰‡åˆ†å¸ƒåœ¨ä¸­é—´åŒºåŸŸ
                        r = (0.35 + (rand - 0.6) * 0.75) * circleRadius;
                    } else {
                        // 10%çš„äº®ç‰‡åˆ†å¸ƒåœ¨ä¸­å¿ƒåŒºåŸŸ
                        r = (rand - 0.9) * 3.5 * 0.35 * circleRadius;
                    }

                    const x = r * Math.cos(angle);
                    const y = r * Math.sin(angle);

                    return { x, y, r, angle };
                }

                // åˆ›å»ºç¢ç‰‡
                for (let i = 0; i < numberOfShards; i++) {
                    // 25%çš„å‡ ç‡åˆ›å»ºå¢å¼ºå‹äº®ç‰‡
                    const isEnhanced = Math.random() < 0.25;

                    const shard = document.createElement('div');
                    shard.classList.add(isEnhanced ? 'shard-enhanced' : 'shard');

                    // å¢å¼ºå‹äº®ç‰‡ç•¥å¤§ä¸€äº›
                    const size = isEnhanced ?
                        Math.random() * 5 + 2 : // å¢å¼ºå‹äº®ç‰‡ 2px åˆ° 7px
                        Math.random() * 4 + 1;  // æ™®é€šäº®ç‰‡ 1px åˆ° 5px

                    shard.style.width = `${size}px`;
                    shard.style.height = `${size * (Math.random() * 0.6 + 0.4)}px`; // ç¢ç‰‡å¯ä»¥æ›´æ‰å¹³

                    // è·å–ä½ç½®
                    const pos = getRandomPosition();

                    // è®¾ç½®ç¢ç‰‡çš„ä½ç½®
                    shard.style.left = `calc(50% + ${pos.x}px - ${parseFloat(shard.style.width) / 2}px)`;
                    shard.style.top = `calc(50% + ${pos.y}px - ${parseFloat(shard.style.height) / 2}px)`;

                    const randomColor = shardColors[Math.floor(Math.random() * shardColors.length)];
                    shard.style.backgroundColor = randomColor;

                    // å¢å¼ºå‹äº®ç‰‡æœ‰æ›´å¼ºçš„å…‰æ™•
                    if (isEnhanced) {
                        shard.style.boxShadow = `0 0 ${Math.random() * 4 + 2}px ${randomColor}`;
                        shard.style.opacity = '0.7';
                    } else {
                        shard.style.boxShadow = `0 0 ${Math.random() * 2 + 1}px ${randomColor}cc`;
                        shard.style.opacity = '0.6';
                    }

                    // ä¸ºæ¯ä¸ªç¢ç‰‡çš„åŠ¨ç”»è®¾ç½®éšæœºå‚æ•°
                    const initialRotation = Math.random() * 360;
                    const midRotation = initialRotation + (Math.random() - 0.5) * 300 + 150;
                    const endRotation = initialRotation + (Math.random() - 0.5) * 600 + 300;

                    const driftRange = 10; // æ¼‚ç§»èŒƒå›´ (px)
                    shard.style.setProperty('--r-start', `${initialRotation}deg`);
                    shard.style.setProperty('--s-drift-start', `${Math.random() * 0.3 + 0.85}`);

                    shard.style.setProperty('--tx-mid', `${(Math.random() - 0.5) * driftRange}px`);
                    shard.style.setProperty('--ty-mid', `${(Math.random() - 0.5) * driftRange}px`);
                    shard.style.setProperty('--r-mid', `${midRotation}deg`);
                    shard.style.setProperty('--s-drift-mid', `${Math.random() * 0.4 + 0.8}`);

                    shard.style.setProperty('--tx-end', `${(Math.random() - 0.5) * (driftRange * 0.6)}px`);
                    shard.style.setProperty('--ty-end', `${(Math.random() - 0.5) * (driftRange * 0.6)}px`);
                    shard.style.setProperty('--r-end', `${endRotation}deg`);
                    shard.style.setProperty('--s-drift-end', shard.style.getPropertyValue('--s-drift-start'));

                    // ä½¿ç”¨ä¸åŒçš„åŠ¨ç”»
                    shard.style.animationName = isEnhanced ?
                        'enhancedShardShimmer, shardDrift' :
                        'shardShimmer, shardDrift';

                    shard.style.animationTimingFunction = 'ease-in-out, cubic-bezier(0.35, 0, 0.65, 1)';
                    shard.style.animationIterationCount = 'infinite, infinite';

                    const shimmerDuration = Math.random() * 2.0 + 1.0; // 1.0s to 3.0s
                    const driftDuration = Math.random() * 12 + 10;     // 10s to 22s
                    shard.style.animationDuration = `${shimmerDuration}s, ${driftDuration}s`;
                    shard.style.animationDelay = `${Math.random() * shimmerDuration * -1}s, ${Math.random() * driftDuration * -1}s`;

                    shardsContainer.appendChild(shard);
                }

                // æ·»åŠ å°‘é‡ç‰¹åˆ«æ˜äº®çš„å¤§äº®ç‰‡
                for (let i = 0; i < 4; i++) { // å‡å°‘åˆ°4ä¸ªå¤§äº®ç‰‡
                    const bigShard = document.createElement('div');
                    bigShard.classList.add('shard-enhanced');

                    const size = Math.random() * 6 + 4; // 4px åˆ° 10px
                    bigShard.style.width = `${size}px`;
                    bigShard.style.height = `${size * (Math.random() * 0.5 + 0.5)}px`;

                    // éšæœºä½ç½®
                    const angle = Math.random() * 2 * Math.PI;
                    let r;

                    if (i < 2) { // 2ä¸ªåœ¨è¾¹ç¼˜
                        r = (0.6 + Math.random() * 0.3) * (circleRadius - size * 2);
                    } else { // 2ä¸ªåœ¨ä¸­å¿ƒåŒºåŸŸ
                        r = Math.random() * 0.6 * (circleRadius - size * 2);
                    }

                    const x = r * Math.cos(angle);
                    const y = r * Math.sin(angle);

                    bigShard.style.left = `calc(50% + ${x}px - ${size / 2}px)`;
                    bigShard.style.top = `calc(50% + ${y}px - ${size / 2}px)`;

                    // éšæœºé¢œè‰²ï¼Œåªä½¿ç”¨ç™½è‰²å’Œæ·¡è“è‰²
                    const brightColors = ['#ffffff', '#ffffff', '#f0f8ff', '#e0ffff'];
                    const randomColor = brightColors[Math.floor(Math.random() * brightColors.length)];
                    bigShard.style.backgroundColor = randomColor;
                    bigShard.style.boxShadow = `0 0 ${Math.random() * 5 + 3}px ${randomColor}`;
                    bigShard.style.opacity = '0.85';

                    // åŠ¨ç”»å‚æ•°
                    const initialRotation = Math.random() * 360;
                    const midRotation = initialRotation + (Math.random() - 0.5) * 200 + 100;
                    const endRotation = initialRotation + (Math.random() - 0.5) * 400 + 200;

                    const driftRange = 8;
                    bigShard.style.setProperty('--r-start', `${initialRotation}deg`);
                    bigShard.style.setProperty('--s-drift-start', `${Math.random() * 0.2 + 0.9}`);

                    bigShard.style.setProperty('--tx-mid', `${(Math.random() - 0.5) * driftRange}px`);
                    bigShard.style.setProperty('--ty-mid', `${(Math.random() - 0.5) * driftRange}px`);
                    bigShard.style.setProperty('--r-mid', `${midRotation}deg`);
                    bigShard.style.setProperty('--s-drift-mid', `${Math.random() * 0.3 + 0.85}`);

                    bigShard.style.setProperty('--tx-end', `${(Math.random() - 0.5) * (driftRange * 0.6)}px`);
                    bigShard.style.setProperty('--ty-end', `${(Math.random() - 0.5) * (driftRange * 0.6)}px`);
                    bigShard.style.setProperty('--r-end', `${endRotation}deg`);
                    bigShard.style.setProperty('--s-drift-end', bigShard.style.getPropertyValue('--s-drift-start'));

                    bigShard.style.animationName = 'enhancedShardShimmer, shardDrift';
                    bigShard.style.animationTimingFunction = 'ease-in-out, cubic-bezier(0.35, 0, 0.65, 1)';
                    bigShard.style.animationIterationCount = 'infinite, infinite';

                    const shimmerDuration = Math.random() * 1.5 + 0.8; // 0.8s to 2.3s
                    const driftDuration = Math.random() * 10 + 8;     // 8s to 18s
                    bigShard.style.animationDuration = `${shimmerDuration}s, ${driftDuration}s`;
                    bigShard.style.animationDelay = `${Math.random() * shimmerDuration * -1}s, ${Math.random() * driftDuration * -1}s`;

                    shardsContainer.appendChild(bigShard);
                }
            }

            // å§å”§ç‚¹å‡»æ—‹è½¬åŠŸèƒ½ + ç²’å­çˆ†ç‚¸æ•ˆæœ
            if (bajiElement) {
                let isSpinning = false;

                bajiElement.addEventListener('click', function() {
                    // å¦‚æœå·²ç»åœ¨æ—‹è½¬ï¼Œåˆ™ä¸æ‰§è¡Œæ–°çš„æ“ä½œ
                    if (isSpinning) return;
                    isSpinning = true;

                    // è§¦å‘ç²’å­çˆ†ç‚¸æ•ˆæœ
                    explodeParticles();

                    this.classList.remove('default-sway');
                    // Ensure perform-spin is not already there, then add it after reflow
                    this.classList.remove('perform-spin');
                    void this.offsetHeight; // Force reflow to restart animation
                    this.classList.add('perform-spin');
                });

                bajiElement.addEventListener('animationend', function(event) {
                    if (event.animationName === 'spin-360') {
                        this.classList.remove('perform-spin');
                        // Only add default-sway if not about to perform another spin immediately
                        if (!this.classList.contains('perform-spin')) {
                            this.classList.add('default-sway');

                            // ç¡®ä¿æ—‹è½¬åèƒŒé¢å›¾ç‰‡ä»ç„¶æ­£ç¡®æ˜¾ç¤ºï¼Œå¹¶æ¢å¤è‡ªå®šä¹‰å›¾ç‰‡
                            setTimeout(() => {
                                // ä½¿ç”¨å·²å£°æ˜çš„backImageå˜é‡
                                if (backImage) {
                                    backImage.style.transform = 'none';
                                }

                                // å¦‚æœæœ‰è‡ªå®šä¹‰å›¾ç‰‡ï¼Œç¡®ä¿å®ƒè¢«æ­£ç¡®åº”ç”¨
                                if (customImageUrl) {
                                    frontImage.src = customImageUrl;
                                }
                            }, 50);

                            isSpinning = false;
                        }
                    }
                });
            }

        });
    </script>

    <!-- ä¿®å¤è¿”å›é“¾æ¥çš„è„šæœ¬ -->
    <script src="../../../js/back-link-fix-new.js"></script>
    <script src="../../../js/back-link-fix-mobile.js"></script>
</body>
</html>